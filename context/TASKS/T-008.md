# T-008: Domain - Player entities (PlaybackState, PlayerControls)

| Campo | Valor |
|-------|-------|
| **Tamanho** | P |
| **Prioridade** | Must Have |
| **Epic** | Player |
| **Depende de** | T-004 |
| **TDD** | Obrigatorio (100%) |

---

## Contexto

Criar entidades de dominio para controle do player de video, incluindo estado de playback e controles.

## Objetivo

Entidades de dominio Player para gerenciar estado de reproducao do video YouTube.

## Escopo

- Value Object: PlaybackState (playing, paused, buffering, ended)
- Value Object: TimePosition (current time, duration)
- Entity: PlayerControls (play, pause, seek, setPlaybackRate)
- Interface: PlayerAdapter (abstrai YouTube IFrame API)
- Testes TDD com 100% cobertura

## Arquivos a Criar

```
src/features/player/
├── domain/
│   ├── value-objects/
│   │   ├── playback-state.ts
│   │   └── time-position.ts
│   ├── entities/
│   │   └── player-controls.ts
│   └── interfaces/
│       └── player-adapter.ts

tests/unit/features/player/
└── domain/
    ├── playback-state.test.ts
    ├── time-position.test.ts
    └── player-controls.test.ts
```

## Implementacao (TDD)

### 1. PlaybackState Value Object

```typescript
// PRIMEIRO: teste
// tests/unit/features/player/domain/playback-state.test.ts
describe('PlaybackState', () => {
  it('should create valid playing state', () => {
    const state = PlaybackState.playing()
    expect(state.isPlaying).toBe(true)
    expect(state.isPaused).toBe(false)
  })

  it('should transition from playing to paused', () => {
    const state = PlaybackState.playing()
    const paused = state.pause()
    expect(paused.isPaused).toBe(true)
  })
})

// DEPOIS: implementacao
// src/features/player/domain/value-objects/playback-state.ts
export class PlaybackState {
  private constructor(
    private readonly state: 'playing' | 'paused' | 'buffering' | 'ended'
  ) {}

  static playing(): PlaybackState {
    return new PlaybackState('playing')
  }

  static paused(): PlaybackState {
    return new PlaybackState('paused')
  }

  get isPlaying(): boolean {
    return this.state === 'playing'
  }

  get isPaused(): boolean {
    return this.state === 'paused'
  }

  pause(): PlaybackState {
    return PlaybackState.paused()
  }

  play(): PlaybackState {
    return PlaybackState.playing()
  }
}
```

### 2. TimePosition Value Object

```typescript
// PRIMEIRO: teste
describe('TimePosition', () => {
  it('should create valid time position', () => {
    const pos = TimePosition.create(30, 180) // 30s de 3min
    expect(pos.currentSeconds).toBe(30)
    expect(pos.durationSeconds).toBe(180)
    expect(pos.progressPercent).toBe(16.67) // arredondado
  })

  it('should reject negative times', () => {
    expect(() => TimePosition.create(-1, 100)).toThrow()
  })

  it('should reject current > duration', () => {
    expect(() => TimePosition.create(200, 100)).toThrow()
  })
})
```

### 3. PlayerAdapter Interface

```typescript
// src/features/player/domain/interfaces/player-adapter.ts
export interface PlayerAdapter {
  play(): void
  pause(): void
  seekTo(seconds: number): void
  getCurrentTime(): number
  getDuration(): number
  getState(): PlaybackState
  setPlaybackRate(rate: number): void
  onStateChange(callback: (state: PlaybackState) => void): void
  onTimeUpdate(callback: (time: TimePosition) => void): void
}
```

## Criterios de Aceite

- [ ] PlaybackState representa estados: playing, paused, buffering, ended
- [ ] TimePosition valida tempos (positivos, current <= duration)
- [ ] PlayerControls orquestra operacoes de controle
- [ ] PlayerAdapter define contrato para implementacoes
- [ ] Cobertura de testes: 100%
- [ ] Todos os testes passam

## Validacao

```bash
pnpm test tests/unit/features/player/domain/
pnpm test:coverage -- --coverage.include="src/features/player/domain/**"
```

---

## Tags de Contexto

```
PRD: features/player
ARQUITETURA: dominios/player, padroes
```

---

## Notas

- TDD OBRIGATORIO: Escrever teste ANTES do codigo
- Value Objects sao imutaveis
- PlayerAdapter e interface - implementacao concreta em T-009
- Nao depende de YouTube API - apenas define contratos
