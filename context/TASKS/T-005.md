# T-005: Infrastructure - YouTubeTranscriptService

| Campo | Valor |
|-------|-------|
| **Tamanho** | M |
| **Prioridade** | Must Have |
| **Epic** | Transcript |
| **Depende de** | T-004 |
| **TDD** | MSW (mocking) |

---

## Contexto

Implementar servico que busca transcricoes do YouTube usando o pacote npm `youtube-transcript`.

## Objetivo

Servico de infraestrutura que implementa a interface TranscriptFetcher, buscando transcricoes do YouTube.

## Escopo

- Implementar YouTubeTranscriptService
- Integrar com pacote youtube-transcript
- Mapear resposta para entidades de dominio
- Tratamento de erros (video sem legenda, video privado, etc)
- Testes com MSW para mockar API

## Arquivos a Criar

```
src/features/transcript/
└── infrastructure/
    └── services/
        └── youtube-transcript-service.ts

tests/integration/features/transcript/
└── youtube-transcript-service.test.ts

tests/mocks/
└── youtube.ts
```

## Implementacao

```typescript
// src/features/transcript/infrastructure/services/youtube-transcript-service.ts
import { YoutubeTranscript } from 'youtube-transcript'
import { TranscriptFetcher, RawTranscript } from '../../domain/interfaces/transcript-fetcher'
import { VideoId } from '../../domain/value-objects/video-id'

export class YouTubeTranscriptService implements TranscriptFetcher {
  async fetch(videoId: VideoId): Promise<Result<RawTranscript, FetchError>> {
    try {
      const segments = await YoutubeTranscript.fetchTranscript(videoId.value)

      return Result.ok({
        videoId: videoId.value,
        segments: segments.map(s => ({
          text: s.text,
          offset: s.offset,
          duration: s.duration
        }))
      })
    } catch (error) {
      if (error.message.includes('disabled')) {
        return Result.fail(new TranscriptDisabledError(videoId.value))
      }
      return Result.fail(new TranscriptFetchError(videoId.value, error.message))
    }
  }
}
```

```typescript
// tests/mocks/youtube.ts
import { http, HttpResponse } from 'msw'

export const youtubeHandlers = [
  http.get('*/api/timedtext*', ({ request }) => {
    const url = new URL(request.url)
    const videoId = url.searchParams.get('v')

    if (videoId === 'no-captions') {
      return HttpResponse.json({ error: 'Transcript disabled' }, { status: 400 })
    }

    return HttpResponse.json({
      events: [
        { tStartMs: 0, dDurationMs: 5000, segs: [{ utf8: 'Hello world' }] },
        { tStartMs: 5000, dDurationMs: 5000, segs: [{ utf8: 'This is a test' }] }
      ]
    })
  })
]
```

## Criterios de Aceite

- [ ] YouTubeTranscriptService implementa TranscriptFetcher
- [ ] Busca transcricao de video valido
- [ ] Retorna erro tipado para video sem legendas
- [ ] Retorna erro tipado para video privado
- [ ] Mapeia segmentos para formato interno
- [ ] Testes com MSW passando

## Validacao

```bash
pnpm test tests/integration/features/transcript/
```

---

## Tags de Contexto

```
PRD: features/transcript
ARQUITETURA: dominios/transcript, decisoes/adr-005-testing-strategy
```

---

## Notas

- Usar pacote `youtube-transcript` do npm
- MSW para mockar respostas do YouTube
- Nao cachear aqui - cache e responsabilidade do repository
