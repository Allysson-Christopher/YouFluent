# T-015: Presentation - LessonCard + ExercisePanel + VocabularyList

| Campo | Valor |
|-------|-------|
| **Tamanho** | M |
| **Prioridade** | Must Have |
| **Epic** | Lesson |
| **Depende de** | T-011, T-003 |
| **TDD** | Component (Vitest) + E2E (Playwright) |

---

## Contexto

Criar componentes de apresentacao para exibir lesson, exercicios interativos e lista de vocabulario.

## Objetivo

Componentes React funcionais para interagir com lesson gerada pela IA.

## Escopo

- Componente LessonCard (resumo da lesson)
- Componente ExercisePanel (exercicios interativos)
- Componente VocabularyList (lista de vocabulario)
- Zustand store para estado da lesson
- Testes de componente e E2E

## Arquivos a Criar

```
src/features/lesson/
└── presentation/
    ├── stores/
    │   └── lesson-store.ts
    └── components/
        ├── lesson-card.tsx
        ├── lesson-card.test.tsx
        ├── exercise-panel.tsx
        ├── exercise-panel.test.tsx
        ├── vocabulary-list.tsx
        └── vocabulary-list.test.tsx

tests/e2e/
└── lesson/
    └── lesson-interaction.spec.ts
```

## Implementacao

### 1. Zustand Lesson Store

```typescript
// src/features/lesson/presentation/stores/lesson-store.ts
import { create } from 'zustand'
import type { Lesson } from '../../domain/entities/lesson'
import type { Exercise } from '../../domain/entities/exercise'

interface LessonState {
  // State
  lesson: Lesson | null
  currentExerciseIndex: number
  answers: Map<string, string>
  score: number
  isComplete: boolean

  // Actions
  setLesson: (lesson: Lesson) => void
  submitAnswer: (exerciseId: string, answer: string) => void
  nextExercise: () => void
  previousExercise: () => void
  reset: () => void

  // Computed
  currentExercise: () => Exercise | null
  progress: () => number
  isCorrect: (exerciseId: string) => boolean | null
}

export const useLessonStore = create<LessonState>((set, get) => ({
  // Initial state
  lesson: null,
  currentExerciseIndex: 0,
  answers: new Map(),
  score: 0,
  isComplete: false,

  // Actions
  setLesson: (lesson) => set({
    lesson,
    currentExerciseIndex: 0,
    answers: new Map(),
    score: 0,
    isComplete: false
  }),

  submitAnswer: (exerciseId, answer) => {
    const { lesson, answers, score } = get()
    const exercise = lesson?.exercises.find(e => e.id === exerciseId)

    if (!exercise) return

    const newAnswers = new Map(answers)
    newAnswers.set(exerciseId, answer)

    const isCorrect = exercise.answer.toLowerCase() === answer.toLowerCase()
    const newScore = isCorrect ? score + 1 : score

    set({ answers: newAnswers, score: newScore })
  },

  nextExercise: () => {
    const { currentExerciseIndex, lesson } = get()
    const maxIndex = (lesson?.exercises.length ?? 1) - 1

    if (currentExerciseIndex < maxIndex) {
      set({ currentExerciseIndex: currentExerciseIndex + 1 })
    } else {
      set({ isComplete: true })
    }
  },

  previousExercise: () => {
    const { currentExerciseIndex } = get()
    if (currentExerciseIndex > 0) {
      set({ currentExerciseIndex: currentExerciseIndex - 1 })
    }
  },

  reset: () => set({
    currentExerciseIndex: 0,
    answers: new Map(),
    score: 0,
    isComplete: false
  }),

  // Computed
  currentExercise: () => {
    const { lesson, currentExerciseIndex } = get()
    return lesson?.exercises[currentExerciseIndex] ?? null
  },

  progress: () => {
    const { lesson, currentExerciseIndex } = get()
    if (!lesson) return 0
    return ((currentExerciseIndex + 1) / lesson.exercises.length) * 100
  },

  isCorrect: (exerciseId) => {
    const { lesson, answers } = get()
    const exercise = lesson?.exercises.find(e => e.id === exerciseId)
    const answer = answers.get(exerciseId)

    if (!exercise || !answer) return null
    return exercise.answer.toLowerCase() === answer.toLowerCase()
  }
}))
```

### 2. LessonCard Component

```typescript
// src/features/lesson/presentation/components/lesson-card.tsx
'use client'

import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/shared/components/ui/card'
import { Badge } from '@/shared/components/ui/badge'
import { useLessonStore } from '../stores/lesson-store'

export function LessonCard() {
  const { lesson, score, progress, isComplete } = useLessonStore()

  if (!lesson) {
    return <div className="text-muted-foreground">Loading lesson...</div>
  }

  const difficultyColors = {
    easy: 'bg-green-500',
    medium: 'bg-yellow-500',
    hard: 'bg-red-500'
  }

  return (
    <Card>
      <CardHeader>
        <div className="flex justify-between items-start">
          <CardTitle className="text-lg">{lesson.title}</CardTitle>
          <Badge className={difficultyColors[lesson.difficulty.value]}>
            {lesson.difficulty.value}
          </Badge>
        </div>
        <CardDescription>
          {lesson.exercises.length} exercises • {lesson.vocabulary.length} vocabulary words
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-2">
          <div className="flex justify-between text-sm">
            <span>Progress</span>
            <span>{Math.round(progress())}%</span>
          </div>
          <div className="h-2 bg-muted rounded-full overflow-hidden">
            <div
              className="h-full bg-primary transition-all"
              style={{ width: `${progress()}%` }}
            />
          </div>
          {isComplete && (
            <div className="text-center p-4 bg-muted rounded-lg mt-4">
              <p className="text-lg font-semibold">Lesson Complete!</p>
              <p>Score: {score}/{lesson.exercises.length}</p>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  )
}
```

### 3. ExercisePanel Component

```typescript
// src/features/lesson/presentation/components/exercise-panel.tsx
'use client'

import { useState } from 'react'
import { Card, CardHeader, CardTitle, CardContent, CardFooter } from '@/shared/components/ui/card'
import { Button } from '@/shared/components/ui/button'
import { Input } from '@/shared/components/ui/input'
import { useLessonStore } from '../stores/lesson-store'
import { cn } from '@/shared/lib/utils'

export function ExercisePanel() {
  const [userAnswer, setUserAnswer] = useState('')
  const {
    currentExercise,
    submitAnswer,
    nextExercise,
    previousExercise,
    isCorrect,
    currentExerciseIndex,
    lesson
  } = useLessonStore()

  const exercise = currentExercise()

  if (!exercise) {
    return <div className="text-muted-foreground">No exercise available</div>
  }

  const answered = isCorrect(exercise.id) !== null
  const correct = isCorrect(exercise.id)

  const handleSubmit = () => {
    if (!userAnswer.trim()) return
    submitAnswer(exercise.id, userAnswer)
  }

  const handleOptionClick = (option: string) => {
    submitAnswer(exercise.id, option)
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base">
          Exercise {currentExerciseIndex + 1} of {lesson?.exercises.length}
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <p className="text-lg" data-testid="question">{exercise.question}</p>

        {exercise.type.value === 'multiple-choice' && exercise.options ? (
          <div className="grid gap-2">
            {exercise.options.map((option, i) => (
              <Button
                key={i}
                variant={answered ? (option === exercise.answer ? 'default' : 'outline') : 'outline'}
                className={cn(
                  'justify-start',
                  answered && option === exercise.answer && 'bg-green-500',
                  answered && option !== exercise.answer && userAnswer === option && 'bg-red-500'
                )}
                onClick={() => handleOptionClick(option)}
                disabled={answered}
                data-testid={`option-${i}`}
              >
                {option}
              </Button>
            ))}
          </div>
        ) : (
          <div className="flex gap-2">
            <Input
              value={userAnswer}
              onChange={(e) => setUserAnswer(e.target.value)}
              placeholder="Type your answer..."
              disabled={answered}
              data-testid="answer-input"
            />
            <Button
              onClick={handleSubmit}
              disabled={answered || !userAnswer.trim()}
              data-testid="submit-button"
            >
              Submit
            </Button>
          </div>
        )}

        {answered && (
          <div
            className={cn(
              'p-3 rounded-lg',
              correct ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            )}
            data-testid="feedback"
          >
            {correct ? '✓ Correct!' : `✗ Incorrect. The answer is: ${exercise.answer}`}
            {exercise.explanation && (
              <p className="mt-2 text-sm opacity-80">{exercise.explanation}</p>
            )}
          </div>
        )}
      </CardContent>
      <CardFooter className="justify-between">
        <Button
          variant="outline"
          onClick={previousExercise}
          disabled={currentExerciseIndex === 0}
        >
          Previous
        </Button>
        <Button
          onClick={nextExercise}
          disabled={!answered}
          data-testid="next-button"
        >
          {currentExerciseIndex === (lesson?.exercises.length ?? 1) - 1 ? 'Finish' : 'Next'}
        </Button>
      </CardFooter>
    </Card>
  )
}
```

### 4. VocabularyList Component

```typescript
// src/features/lesson/presentation/components/vocabulary-list.tsx
'use client'

import { Card, CardHeader, CardTitle, CardContent } from '@/shared/components/ui/card'
import { useLessonStore } from '../stores/lesson-store'
import { usePlayerStore } from '@/features/player/presentation/stores/player-store'

export function VocabularyList() {
  const { lesson } = useLessonStore()
  const { seekToChunk } = usePlayerStore()

  if (!lesson || lesson.vocabulary.length === 0) {
    return null
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base">Vocabulary ({lesson.vocabulary.length})</CardTitle>
      </CardHeader>
      <CardContent>
        <ul className="space-y-4">
          {lesson.vocabulary.map((item, index) => (
            <li
              key={item.id ?? index}
              className="p-3 bg-muted rounded-lg cursor-pointer hover:bg-accent"
              onClick={() => seekToChunk(item.chunkIndex)}
              data-testid={`vocab-${index}`}
            >
              <div className="flex justify-between items-start">
                <span className="font-semibold">{item.word}</span>
                {item.partOfSpeech && (
                  <span className="text-xs text-muted-foreground italic">
                    {item.partOfSpeech}
                  </span>
                )}
              </div>
              <p className="text-sm text-muted-foreground mt-1">{item.definition}</p>
              <p className="text-sm italic mt-1">"{item.example}"</p>
            </li>
          ))}
        </ul>
      </CardContent>
    </Card>
  )
}
```

### 5. Teste E2E

```typescript
// tests/e2e/lesson/lesson-interaction.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Lesson Interaction', () => {
  test('should complete fill-blank exercise', async ({ page }) => {
    await page.goto('/lesson/dQw4w9WgXcQ')

    // Wait for lesson to load
    await expect(page.locator('[data-testid="question"]')).toBeVisible()

    // Type answer
    await page.fill('[data-testid="answer-input"]', 'went')
    await page.click('[data-testid="submit-button"]')

    // Should show feedback
    await expect(page.locator('[data-testid="feedback"]')).toBeVisible()

    // Go to next
    await page.click('[data-testid="next-button"]')
  })

  test('should complete multiple-choice exercise', async ({ page }) => {
    await page.goto('/lesson/dQw4w9WgXcQ?exercise=2')

    // Click correct option
    await page.click('[data-testid="option-0"]')

    // Should show correct feedback
    await expect(page.locator('[data-testid="feedback"]')).toContainText('Correct')
  })

  test('should navigate vocabulary and seek video', async ({ page }) => {
    await page.goto('/lesson/dQw4w9WgXcQ')

    // Click vocabulary item
    await page.click('[data-testid="vocab-0"]')

    // Video should seek to chunk
    await expect(page.locator('[data-testid="current-time"]')).not.toHaveText('0:00')
  })
})
```

## Criterios de Aceite

- [ ] LessonCard exibe titulo, dificuldade, progresso
- [ ] ExercisePanel suporta fill-blank e multiple-choice
- [ ] ExercisePanel mostra feedback correto/incorreto
- [ ] VocabularyList exibe word, definition, example
- [ ] Click em vocabulario faz seek no video
- [ ] Zustand store gerencia estado da lesson
- [ ] Navegacao entre exercicios funciona
- [ ] Testes de componente passam
- [ ] Testes E2E passam

## Validacao

```bash
pnpm test src/features/lesson/presentation/
pnpm test:e2e tests/e2e/lesson/
```

---

## Tags de Contexto

```
PRD: features/lesson
ARQUITETURA: dominios/lesson, stack, decisoes/adr-003-zustand
```

---

## Notas

- shadcn/ui componentes para UI consistente
- Zustand para estado local da lesson
- Integracao com player store para seek
- Feedback visual imediato ao responder
