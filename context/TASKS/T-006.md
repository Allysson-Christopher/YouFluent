# T-006: Infrastructure - PrismaTranscriptRepository

| Campo | Valor |
|-------|-------|
| **Tamanho** | M |
| **Prioridade** | Must Have |
| **Epic** | Transcript |
| **Depende de** | T-004, T-002 |
| **TDD** | Testcontainers |

---

## Contexto

Implementar repositorio Prisma para persistir e buscar transcricoes no PostgreSQL. Este e o cache de transcricoes.

## Objetivo

Repositorio que implementa TranscriptRepository com Prisma, salvando e buscando transcricoes do banco de dados.

## Escopo

- Criar schema Prisma para Transcript e Chunk
- Implementar PrismaTranscriptRepository
- Implementar mapper Domain <-> Prisma
- Testes com Testcontainers (PostgreSQL real)

## Arquivos a Criar/Modificar

```
prisma/
└── schema.prisma              # Adicionar models Transcript e Chunk

src/features/transcript/
└── infrastructure/
    ├── repositories/
    │   └── prisma-transcript-repository.ts
    └── mappers/
        └── transcript-mapper.ts

tests/integration/features/transcript/
└── prisma-transcript-repository.test.ts
```

## Implementacao

```prisma
// prisma/schema.prisma
model Transcript {
  id        String   @id @default(cuid())
  videoId   String   @unique
  title     String
  language  String   @default("en")
  fullText  String   @db.Text
  createdAt DateTime @default(now())
  chunks    Chunk[]

  @@index([videoId])
}

model Chunk {
  id           String     @id @default(cuid())
  index        Int
  startTime    Float
  endTime      Float
  text         String     @db.Text
  transcriptId String
  transcript   Transcript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)

  @@index([transcriptId])
}
```

```typescript
// src/features/transcript/infrastructure/repositories/prisma-transcript-repository.ts
import { PrismaClient } from '@prisma/client'
import { TranscriptRepository } from '../../domain/interfaces/transcript-repository'
import { Transcript } from '../../domain/entities/transcript'
import { VideoId } from '../../domain/value-objects/video-id'
import { TranscriptMapper } from '../mappers/transcript-mapper'

export class PrismaTranscriptRepository implements TranscriptRepository {
  constructor(private readonly prisma: PrismaClient) {}

  async findByVideoId(videoId: VideoId): Promise<Transcript | null> {
    const data = await this.prisma.transcript.findUnique({
      where: { videoId: videoId.value },
      include: { chunks: { orderBy: { index: 'asc' } } }
    })
    return data ? TranscriptMapper.toDomain(data) : null
  }

  async save(transcript: Transcript): Promise<void> {
    const data = TranscriptMapper.toPrisma(transcript)
    await this.prisma.transcript.create({
      data: {
        ...data,
        chunks: { create: data.chunks }
      }
    })
  }
}
```

```typescript
// tests/integration/features/transcript/prisma-transcript-repository.test.ts
import { PostgreSqlContainer, StartedPostgreSqlContainer } from '@testcontainers/postgresql'
import { PrismaClient } from '@prisma/client'
import { execSync } from 'child_process'

describe('PrismaTranscriptRepository', () => {
  let container: StartedPostgreSqlContainer
  let prisma: PrismaClient

  beforeAll(async () => {
    container = await new PostgreSqlContainer().start()

    process.env.DATABASE_URL = container.getConnectionUri()
    execSync('pnpm prisma db push', { env: process.env })

    prisma = new PrismaClient()
  }, 60000)

  afterAll(async () => {
    await prisma.$disconnect()
    await container.stop()
  })

  it('should save and retrieve transcript', async () => {
    const repo = new PrismaTranscriptRepository(prisma)
    const transcript = createTestTranscript()

    await repo.save(transcript)
    const found = await repo.findByVideoId(transcript.videoId)

    expect(found).not.toBeNull()
    expect(found?.videoId.value).toBe(transcript.videoId.value)
    expect(found?.chunks).toHaveLength(transcript.chunks.length)
  })
})
```

## Criterios de Aceite

- [ ] Schema Prisma criado para Transcript e Chunk
- [ ] Migration aplicada com sucesso
- [ ] findByVideoId retorna null se nao existir
- [ ] findByVideoId retorna Transcript com Chunks se existir
- [ ] save persiste Transcript e Chunks
- [ ] Mapper converte corretamente Domain <-> Prisma
- [ ] Testes com Testcontainers passando

## Validacao

```bash
pnpm prisma generate
pnpm prisma db push
pnpm test tests/integration/features/transcript/prisma-transcript-repository.test.ts
```

---

## Tags de Contexto

```
PRD: features/transcript
ARQUITETURA: dominios/transcript, decisoes/adr-004-cache-postgres
```

---

## Notas

- Testcontainers requer Docker rodando
- Timeout de 60s para iniciar container
- Indice em videoId para queries rapidas
