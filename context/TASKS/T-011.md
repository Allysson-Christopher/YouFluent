# T-011: Domain - Lesson entities (Lesson, Exercise, VocabularyItem)

| Campo | Valor |
|-------|-------|
| **Tamanho** | M |
| **Prioridade** | Must Have |
| **Epic** | Lesson |
| **Depende de** | T-004 |
| **TDD** | Obrigatorio (100%) |

---

## Contexto

Criar entidades de dominio para Lesson seguindo DDD. Lesson e o agregado principal que contem exercicios e vocabulario gerados pela IA.

## Objetivo

Entidades de dominio Lesson completas com validacao, value objects e interfaces.

## Escopo

- Entity: Lesson (agregado principal)
- Entity: Exercise (exercicio interativo)
- Entity: VocabularyItem (item de vocabulario)
- Value Object: Difficulty (easy, medium, hard)
- Value Object: ExerciseType (fill-blank, multiple-choice, etc)
- Interface: LessonRepository
- Interface: LessonGenerator (contrato para IA)
- Testes TDD com 100% cobertura

## Arquivos a Criar

```
src/features/lesson/
├── domain/
│   ├── entities/
│   │   ├── lesson.ts
│   │   ├── exercise.ts
│   │   └── vocabulary-item.ts
│   ├── value-objects/
│   │   ├── difficulty.ts
│   │   └── exercise-type.ts
│   ├── interfaces/
│   │   ├── lesson-repository.ts
│   │   └── lesson-generator.ts
│   └── errors/
│       └── lesson-errors.ts

tests/unit/features/lesson/
└── domain/
    ├── lesson.test.ts
    ├── exercise.test.ts
    ├── vocabulary-item.test.ts
    ├── difficulty.test.ts
    └── exercise-type.test.ts
```

## Implementacao (TDD)

### 1. Difficulty Value Object

```typescript
// PRIMEIRO: teste
// tests/unit/features/lesson/domain/difficulty.test.ts
describe('Difficulty', () => {
  it('should create valid difficulties', () => {
    expect(Difficulty.easy().value).toBe('easy')
    expect(Difficulty.medium().value).toBe('medium')
    expect(Difficulty.hard().value).toBe('hard')
  })

  it('should parse from string', () => {
    const result = Difficulty.fromString('medium')
    expect(result.isSuccess).toBe(true)
    expect(result.value.value).toBe('medium')
  })

  it('should reject invalid difficulty', () => {
    const result = Difficulty.fromString('impossible')
    expect(result.isFailure).toBe(true)
  })
})

// DEPOIS: implementacao
// src/features/lesson/domain/value-objects/difficulty.ts
export class Difficulty {
  private constructor(readonly value: 'easy' | 'medium' | 'hard') {}

  static easy(): Difficulty { return new Difficulty('easy') }
  static medium(): Difficulty { return new Difficulty('medium') }
  static hard(): Difficulty { return new Difficulty('hard') }

  static fromString(value: string): Result<Difficulty, InvalidDifficultyError> {
    if (!['easy', 'medium', 'hard'].includes(value)) {
      return Result.fail(new InvalidDifficultyError(value))
    }
    return Result.ok(new Difficulty(value as 'easy' | 'medium' | 'hard'))
  }
}
```

### 2. ExerciseType Value Object

```typescript
// PRIMEIRO: teste
describe('ExerciseType', () => {
  it('should support fill-blank type', () => {
    const type = ExerciseType.fillBlank()
    expect(type.value).toBe('fill-blank')
    expect(type.requiresTextInput).toBe(true)
  })

  it('should support multiple-choice type', () => {
    const type = ExerciseType.multipleChoice()
    expect(type.value).toBe('multiple-choice')
    expect(type.requiresTextInput).toBe(false)
  })
})

// DEPOIS: implementacao
export class ExerciseType {
  private constructor(
    readonly value: 'fill-blank' | 'multiple-choice' | 'translation' | 'listening'
  ) {}

  static fillBlank(): ExerciseType { return new ExerciseType('fill-blank') }
  static multipleChoice(): ExerciseType { return new ExerciseType('multiple-choice') }
  static translation(): ExerciseType { return new ExerciseType('translation') }
  static listening(): ExerciseType { return new ExerciseType('listening') }

  get requiresTextInput(): boolean {
    return ['fill-blank', 'translation'].includes(this.value)
  }
}
```

### 3. Exercise Entity

```typescript
// PRIMEIRO: teste
describe('Exercise', () => {
  it('should create valid exercise', () => {
    const exercise = Exercise.create({
      type: ExerciseType.fillBlank(),
      question: 'Complete: I ___ to the store',
      answer: 'went',
      options: null,
      chunkIndex: 0
    })
    expect(exercise.isSuccess).toBe(true)
  })

  it('should require options for multiple-choice', () => {
    const exercise = Exercise.create({
      type: ExerciseType.multipleChoice(),
      question: 'What did he say?',
      answer: 'Hello',
      options: null, // Deveria ter opcoes
      chunkIndex: 0
    })
    expect(exercise.isFailure).toBe(true)
  })

  it('should validate answer is in options', () => {
    const exercise = Exercise.create({
      type: ExerciseType.multipleChoice(),
      question: 'What?',
      answer: 'C',
      options: ['A', 'B'], // Answer nao esta nas opcoes
      chunkIndex: 0
    })
    expect(exercise.isFailure).toBe(true)
  })
})
```

### 4. VocabularyItem Entity

```typescript
// PRIMEIRO: teste
describe('VocabularyItem', () => {
  it('should create valid vocabulary item', () => {
    const item = VocabularyItem.create({
      word: 'serendipity',
      definition: 'Finding something good by accident',
      example: 'It was pure serendipity that we met.',
      chunkIndex: 2
    })
    expect(item.isSuccess).toBe(true)
    expect(item.value.word).toBe('serendipity')
  })

  it('should reject empty word', () => {
    const item = VocabularyItem.create({
      word: '',
      definition: 'Something',
      example: 'Example',
      chunkIndex: 0
    })
    expect(item.isFailure).toBe(true)
  })
})
```

### 5. Lesson Aggregate

```typescript
// PRIMEIRO: teste
describe('Lesson', () => {
  it('should create lesson with exercises and vocabulary', () => {
    const lesson = Lesson.create({
      videoId: VideoId.fromUrl('https://youtu.be/abc123').value,
      title: 'Learn English',
      difficulty: Difficulty.medium(),
      exercises: [exercise1, exercise2],
      vocabulary: [vocab1, vocab2, vocab3]
    })
    expect(lesson.isSuccess).toBe(true)
    expect(lesson.value.exerciseCount).toBe(2)
    expect(lesson.value.vocabularyCount).toBe(3)
  })

  it('should require at least one exercise', () => {
    const lesson = Lesson.create({
      videoId: VideoId.fromUrl('https://youtu.be/abc123').value,
      title: 'Learn English',
      difficulty: Difficulty.medium(),
      exercises: [], // Vazio
      vocabulary: [vocab1]
    })
    expect(lesson.isFailure).toBe(true)
  })
})
```

### 6. Interfaces

```typescript
// src/features/lesson/domain/interfaces/lesson-repository.ts
export interface LessonRepository {
  findByVideoId(videoId: VideoId): Promise<Lesson | null>
  save(lesson: Lesson): Promise<void>
}

// src/features/lesson/domain/interfaces/lesson-generator.ts
export interface LessonGenerator {
  generate(
    transcript: Transcript,
    difficulty: Difficulty
  ): Promise<Result<GeneratedLesson, LessonGenerationError>>
}

export interface GeneratedLesson {
  exercises: ExerciseData[]
  vocabulary: VocabularyData[]
}
```

## Criterios de Aceite

- [ ] Difficulty suporta easy, medium, hard
- [ ] ExerciseType suporta 4 tipos de exercicio
- [ ] Exercise valida tipo vs opcoes (multiple-choice precisa de opcoes)
- [ ] VocabularyItem tem word, definition, example
- [ ] Lesson e aggregate root com exercises e vocabulary
- [ ] Lesson requer pelo menos 1 exercicio
- [ ] Interfaces definidas para repository e generator
- [ ] Cobertura de testes: 100%

## Validacao

```bash
pnpm test tests/unit/features/lesson/domain/
pnpm test:coverage -- --coverage.include="src/features/lesson/domain/**"
```

---

## Tags de Contexto

```
PRD: features/lesson
ARQUITETURA: dominios/lesson, padroes
```

---

## Notas

- TDD OBRIGATORIO: Escrever teste ANTES do codigo
- Lesson e aggregate root - controla consistencia
- Exercises e Vocabulary sao entities dentro do aggregate
- Generator retorna dados brutos, Lesson.create valida
