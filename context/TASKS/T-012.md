# T-012: Infrastructure - OpenAILessonGenerator

| Campo | Valor |
|-------|-------|
| **Tamanho** | M |
| **Prioridade** | Must Have |
| **Epic** | Lesson |
| **Depende de** | T-011 |
| **TDD** | MSW (mocking) |

---

## Contexto

Implementar servico que usa OpenAI API para gerar exercicios e vocabulario a partir de transcricao.

## Objetivo

Servico de infraestrutura que implementa LessonGenerator usando OpenAI API com structured outputs.

## Escopo

- Implementar OpenAILessonGenerator
- Prompts para geracao de exercicios
- Prompts para extracao de vocabulario
- Structured outputs com Zod schema
- Tratamento de erros (rate limit, timeout, etc)
- Testes com MSW

## Arquivos a Criar

```
src/features/lesson/
└── infrastructure/
    └── services/
        ├── openai-lesson-generator.ts
        └── prompts/
            ├── exercise-prompt.ts
            └── vocabulary-prompt.ts

tests/integration/features/lesson/
└── openai-lesson-generator.test.ts

tests/mocks/
└── openai.ts
```

## Implementacao

### 1. Zod Schemas para Structured Output

```typescript
// src/features/lesson/infrastructure/services/prompts/schemas.ts
import { z } from 'zod'

export const exerciseSchema = z.object({
  type: z.enum(['fill-blank', 'multiple-choice', 'translation', 'listening']),
  question: z.string().min(10),
  answer: z.string().min(1),
  options: z.array(z.string()).nullable(),
  chunkIndex: z.number().int().min(0),
  explanation: z.string().optional()
})

export const vocabularySchema = z.object({
  word: z.string().min(1),
  definition: z.string().min(10),
  example: z.string().min(10),
  chunkIndex: z.number().int().min(0),
  partOfSpeech: z.enum(['noun', 'verb', 'adjective', 'adverb', 'other']).optional()
})

export const lessonOutputSchema = z.object({
  exercises: z.array(exerciseSchema).min(1).max(10),
  vocabulary: z.array(vocabularySchema).min(1).max(15)
})

export type LessonOutput = z.infer<typeof lessonOutputSchema>
```

### 2. Prompts

```typescript
// src/features/lesson/infrastructure/services/prompts/exercise-prompt.ts
import { Difficulty } from '../../../domain/value-objects/difficulty'
import { Chunk } from '@/features/transcript/domain/entities/chunk'

export function buildExercisePrompt(chunks: Chunk[], difficulty: Difficulty): string {
  const difficultyInstructions = {
    easy: 'Create simple exercises focusing on basic vocabulary and common phrases.',
    medium: 'Create moderate exercises with some challenging vocabulary and grammar.',
    hard: 'Create challenging exercises with advanced vocabulary, idioms, and complex grammar.'
  }

  return `
You are an English teacher creating exercises from video transcript chunks.

DIFFICULTY: ${difficulty.value}
${difficultyInstructions[difficulty.value]}

TRANSCRIPT CHUNKS:
${chunks.map((c, i) => `[Chunk ${i}] ${c.text}`).join('\n')}

INSTRUCTIONS:
1. Create 5-8 exercises based on the transcript content
2. Include a mix of exercise types:
   - fill-blank: Sentence with a blank for missing word
   - multiple-choice: Question with 4 options
   - translation: Phrase to translate
3. Each exercise must reference a specific chunk (chunkIndex)
4. For multiple-choice, include exactly 4 options with the correct answer included
5. Provide brief explanations for answers

OUTPUT FORMAT: JSON matching the provided schema
`
}

// src/features/lesson/infrastructure/services/prompts/vocabulary-prompt.ts
export function buildVocabularyPrompt(chunks: Chunk[], difficulty: Difficulty): string {
  return `
You are an English teacher extracting vocabulary from video transcript.

DIFFICULTY: ${difficulty.value}

TRANSCRIPT CHUNKS:
${chunks.map((c, i) => `[Chunk ${i}] ${c.text}`).join('\n')}

INSTRUCTIONS:
1. Extract 8-12 vocabulary words appropriate for the difficulty level
2. Focus on:
   - ${difficulty.value === 'easy' ? 'common words that might be new to beginners' : ''}
   - ${difficulty.value === 'medium' ? 'intermediate vocabulary and phrasal verbs' : ''}
   - ${difficulty.value === 'hard' ? 'advanced vocabulary, idioms, and technical terms' : ''}
3. Each word must have:
   - Clear definition
   - Example sentence (can be from transcript or created)
   - The chunk where it appears (chunkIndex)
4. Include part of speech when relevant

OUTPUT FORMAT: JSON matching the provided schema
`
}
```

### 3. OpenAILessonGenerator

```typescript
// src/features/lesson/infrastructure/services/openai-lesson-generator.ts
import OpenAI from 'openai'
import { zodResponseFormat } from 'openai/helpers/zod'
import { LessonGenerator, GeneratedLesson } from '../../domain/interfaces/lesson-generator'
import { Transcript } from '@/features/transcript/domain/entities/transcript'
import { Difficulty } from '../../domain/value-objects/difficulty'
import { lessonOutputSchema, LessonOutput } from './prompts/schemas'
import { buildExercisePrompt } from './prompts/exercise-prompt'
import { buildVocabularyPrompt } from './prompts/vocabulary-prompt'
import { Result } from '@/shared/lib/result'

export class OpenAILessonGenerator implements LessonGenerator {
  private client: OpenAI

  constructor(apiKey?: string) {
    this.client = new OpenAI({
      apiKey: apiKey ?? process.env.OPENAI_API_KEY
    })
  }

  async generate(
    transcript: Transcript,
    difficulty: Difficulty
  ): Promise<Result<GeneratedLesson, LessonGenerationError>> {
    try {
      const chunks = transcript.chunks

      // Generate exercises
      const exercisePrompt = buildExercisePrompt(chunks, difficulty)
      const vocabularyPrompt = buildVocabularyPrompt(chunks, difficulty)

      const response = await this.client.chat.completions.create({
        model: 'gpt-4o-mini',
        messages: [
          {
            role: 'system',
            content: 'You are an expert English teacher creating interactive lessons.'
          },
          {
            role: 'user',
            content: `${exercisePrompt}\n\n${vocabularyPrompt}`
          }
        ],
        response_format: zodResponseFormat(lessonOutputSchema, 'lesson')
      })

      const content = response.choices[0]?.message?.content
      if (!content) {
        return Result.fail(new EmptyResponseError())
      }

      const parsed = lessonOutputSchema.parse(JSON.parse(content))

      return Result.ok({
        exercises: parsed.exercises,
        vocabulary: parsed.vocabulary
      })
    } catch (error) {
      if (error instanceof OpenAI.RateLimitError) {
        return Result.fail(new RateLimitError())
      }
      if (error instanceof OpenAI.APIError) {
        return Result.fail(new APIError(error.message))
      }
      return Result.fail(new LessonGenerationError(String(error)))
    }
  }
}
```

### 4. MSW Handlers

```typescript
// tests/mocks/openai.ts
import { http, HttpResponse } from 'msw'

const mockLessonResponse = {
  exercises: [
    {
      type: 'fill-blank',
      question: 'I ___ to the store yesterday.',
      answer: 'went',
      options: null,
      chunkIndex: 0,
      explanation: 'Past tense of "go"'
    },
    {
      type: 'multiple-choice',
      question: 'What does "serendipity" mean?',
      answer: 'Finding good things by accident',
      options: [
        'Finding good things by accident',
        'Being very careful',
        'A type of dessert',
        'A musical instrument'
      ],
      chunkIndex: 1
    }
  ],
  vocabulary: [
    {
      word: 'serendipity',
      definition: 'The occurrence of events by chance in a happy way',
      example: 'It was pure serendipity that we met at the conference.',
      chunkIndex: 1,
      partOfSpeech: 'noun'
    }
  ]
}

export const openaiHandlers = [
  http.post('https://api.openai.com/v1/chat/completions', () => {
    return HttpResponse.json({
      id: 'chatcmpl-123',
      object: 'chat.completion',
      created: Date.now(),
      model: 'gpt-4o-mini',
      choices: [
        {
          index: 0,
          message: {
            role: 'assistant',
            content: JSON.stringify(mockLessonResponse)
          },
          finish_reason: 'stop'
        }
      ]
    })
  })
]
```

### 5. Testes

```typescript
// tests/integration/features/lesson/openai-lesson-generator.test.ts
import { setupServer } from 'msw/node'
import { openaiHandlers } from '../../../mocks/openai'
import { OpenAILessonGenerator } from '@/features/lesson/infrastructure/services/openai-lesson-generator'

const server = setupServer(...openaiHandlers)

describe('OpenAILessonGenerator', () => {
  beforeAll(() => server.listen())
  afterEach(() => server.resetHandlers())
  afterAll(() => server.close())

  it('should generate exercises and vocabulary', async () => {
    const generator = new OpenAILessonGenerator('test-key')
    const transcript = createMockTranscript()
    const difficulty = Difficulty.medium()

    const result = await generator.generate(transcript, difficulty)

    expect(result.isSuccess).toBe(true)
    expect(result.value.exercises.length).toBeGreaterThan(0)
    expect(result.value.vocabulary.length).toBeGreaterThan(0)
  })

  it('should handle rate limit errors', async () => {
    server.use(
      http.post('https://api.openai.com/v1/chat/completions', () => {
        return HttpResponse.json(
          { error: { message: 'Rate limit exceeded' } },
          { status: 429 }
        )
      })
    )

    const generator = new OpenAILessonGenerator('test-key')
    const result = await generator.generate(createMockTranscript(), Difficulty.easy())

    expect(result.isFailure).toBe(true)
    expect(result.error).toBeInstanceOf(RateLimitError)
  })
})
```

## Criterios de Aceite

- [ ] OpenAILessonGenerator implementa LessonGenerator
- [ ] Usa structured outputs com Zod schema
- [ ] Gera 5-8 exercicios por lesson
- [ ] Gera 8-12 vocabulary items
- [ ] Prompt adapta conteudo por dificuldade
- [ ] Erros tipados para rate limit, API errors
- [ ] Testes com MSW passam

## Validacao

```bash
pnpm test tests/integration/features/lesson/openai-lesson-generator.test.ts
```

---

## Tags de Contexto

```
PRD: features/lesson
ARQUITETURA: dominios/lesson, stack
```

---

## Notas

- Usar gpt-4o-mini para custo/beneficio
- Structured outputs garantem formato correto
- Zod schema valida resposta da API
- MSW mocka API para testes deterministas
