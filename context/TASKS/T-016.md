# T-016: Pages - Home + Lesson Page + Routing

| Campo | Valor |
|-------|-------|
| **Tamanho** | M |
| **Prioridade** | Must Have |
| **Epic** | Integration |
| **Depende de** | T-009, T-010, T-014, T-015 |
| **TDD** | E2E (Playwright) |

---

## Contexto

Criar as paginas da aplicacao: Home (input de URL) e Lesson (player + exercicios). Integrar todos os componentes.

## Objetivo

Aplicacao funcional end-to-end: usuario cola URL, gera lesson, interage com exercicios.

## Escopo

- Pagina Home (input de URL YouTube)
- Pagina Lesson (player + chunks + exercises + vocabulary)
- Layout responsivo
- Loading e error states
- Server Actions para geracao de lesson
- Testes E2E completos

## Arquivos a Criar

```
src/app/
â”œâ”€â”€ page.tsx                   # Home page
â”œâ”€â”€ layout.tsx                 # Root layout
â”œâ”€â”€ loading.tsx                # Loading UI
â”œâ”€â”€ error.tsx                  # Error UI
â””â”€â”€ lesson/
    â””â”€â”€ [videoId]/
        â”œâ”€â”€ page.tsx           # Lesson page
        â”œâ”€â”€ loading.tsx        # Lesson loading
        â””â”€â”€ actions.ts         # Server actions

src/shared/
â””â”€â”€ components/
    â””â”€â”€ url-input-form.tsx     # Form de URL

tests/e2e/
â”œâ”€â”€ home.spec.ts
â””â”€â”€ lesson-flow.spec.ts
```

## Implementacao

### 1. Root Layout

```typescript
// src/app/layout.tsx
import { Inter } from 'next/font/google'
import './globals.css'

const inter = Inter({ subsets: ['latin'] })

export const metadata = {
  title: 'YouFluent - Learn English with YouTube',
  description: 'Transform any YouTube video into an interactive English lesson'
}

export default function RootLayout({
  children
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <main className="min-h-screen bg-background">
          {children}
        </main>
      </body>
    </html>
  )
}
```

### 2. Home Page

```typescript
// src/app/page.tsx
import { UrlInputForm } from '@/shared/components/url-input-form'

export default function HomePage() {
  return (
    <div className="container mx-auto px-4 py-16">
      <div className="max-w-2xl mx-auto text-center">
        <h1 className="text-4xl font-bold tracking-tight mb-4">
          Learn English with YouTube
        </h1>
        <p className="text-xl text-muted-foreground mb-8">
          Paste any YouTube video URL and get an interactive English lesson
          with exercises and vocabulary.
        </p>

        <UrlInputForm />

        <div className="mt-16 grid gap-8 md:grid-cols-3">
          <div className="p-6 border rounded-lg">
            <h3 className="font-semibold mb-2">ðŸ“º Any Video</h3>
            <p className="text-sm text-muted-foreground">
              Works with any YouTube video that has subtitles
            </p>
          </div>
          <div className="p-6 border rounded-lg">
            <h3 className="font-semibold mb-2">ðŸ¤– AI-Powered</h3>
            <p className="text-sm text-muted-foreground">
              Exercises and vocabulary generated by AI
            </p>
          </div>
          <div className="p-6 border rounded-lg">
            <h3 className="font-semibold mb-2">ðŸ“Š 3 Difficulty Levels</h3>
            <p className="text-sm text-muted-foreground">
              Easy, Medium, and Hard to match your level
            </p>
          </div>
        </div>
      </div>
    </div>
  )
}
```

### 3. URL Input Form

```typescript
// src/shared/components/url-input-form.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/shared/components/ui/button'
import { Input } from '@/shared/components/ui/input'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/shared/components/ui/select'
import { VideoId } from '@/features/transcript/domain/value-objects/video-id'

export function UrlInputForm() {
  const [url, setUrl] = useState('')
  const [difficulty, setDifficulty] = useState('medium')
  const [error, setError] = useState('')
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')

    // Validate URL
    const videoIdResult = VideoId.fromUrl(url)
    if (videoIdResult.isFailure) {
      setError('Please enter a valid YouTube URL')
      return
    }

    setLoading(true)

    // Navigate to lesson page
    router.push(`/lesson/${videoIdResult.value.value}?difficulty=${difficulty}`)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="flex gap-2">
        <Input
          type="url"
          placeholder="https://www.youtube.com/watch?v=..."
          value={url}
          onChange={(e) => setUrl(e.target.value)}
          className="flex-1"
          data-testid="url-input"
        />
        <Select value={difficulty} onValueChange={setDifficulty}>
          <SelectTrigger className="w-32" data-testid="difficulty-select">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="easy">Easy</SelectItem>
            <SelectItem value="medium">Medium</SelectItem>
            <SelectItem value="hard">Hard</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {error && (
        <p className="text-sm text-destructive" data-testid="error-message">
          {error}
        </p>
      )}

      <Button
        type="submit"
        className="w-full"
        disabled={loading || !url}
        data-testid="submit-button"
      >
        {loading ? 'Generating Lesson...' : 'Start Learning'}
      </Button>
    </form>
  )
}
```

### 4. Lesson Page

```typescript
// src/app/lesson/[videoId]/page.tsx
import { Suspense } from 'react'
import { notFound } from 'next/navigation'
import { VideoPlayer } from '@/features/player/presentation/components/video-player'
import { ChunkNavigator } from '@/features/player/presentation/components/chunk-navigator'
import { LessonCard } from '@/features/lesson/presentation/components/lesson-card'
import { ExercisePanel } from '@/features/lesson/presentation/components/exercise-panel'
import { VocabularyList } from '@/features/lesson/presentation/components/vocabulary-list'
import { generateLesson } from './actions'
import { LessonProvider } from './lesson-provider'

interface LessonPageProps {
  params: { videoId: string }
  searchParams: { difficulty?: string }
}

export default async function LessonPage({
  params,
  searchParams
}: LessonPageProps) {
  const { videoId } = params
  const difficulty = searchParams.difficulty ?? 'medium'

  // Generate or fetch lesson
  const result = await generateLesson(videoId, difficulty)

  if (result.isFailure) {
    // Handle specific errors
    if (result.error.type === 'INVALID_VIDEO') {
      notFound()
    }
    throw result.error
  }

  const { lesson, transcript } = result.value

  return (
    <LessonProvider lesson={lesson} transcript={transcript}>
      <div className="container mx-auto px-4 py-8">
        <div className="grid gap-6 lg:grid-cols-3">
          {/* Main content - Player + Exercises */}
          <div className="lg:col-span-2 space-y-6">
            <Suspense fallback={<div className="aspect-video bg-muted animate-pulse" />}>
              <VideoPlayer videoId={videoId} />
            </Suspense>

            <LessonCard />
            <ExercisePanel />
          </div>

          {/* Sidebar - Chunks + Vocabulary */}
          <div className="space-y-6">
            <ChunkNavigator />
            <VocabularyList />
          </div>
        </div>
      </div>
    </LessonProvider>
  )
}
```

### 5. Server Actions

```typescript
// src/app/lesson/[videoId]/actions.ts
'use server'

import { GenerateLessonUseCase } from '@/features/lesson/application/use-cases/generate-lesson'
import { FetchTranscriptUseCase } from '@/features/transcript/application/use-cases/fetch-transcript'
import { PrismaLessonRepository } from '@/features/lesson/infrastructure/repositories/prisma-lesson-repository'
import { PrismaTranscriptRepository } from '@/features/transcript/infrastructure/repositories/prisma-transcript-repository'
import { YouTubeTranscriptService } from '@/features/transcript/infrastructure/services/youtube-transcript-service'
import { OpenAILessonGenerator } from '@/features/lesson/infrastructure/services/openai-lesson-generator'
import { ChunkTranscriptUseCase } from '@/features/transcript/application/use-cases/chunk-transcript'
import { Difficulty } from '@/features/lesson/domain/value-objects/difficulty'
import { prisma } from '@/shared/lib/prisma'
import { Result } from '@/shared/lib/result'

export async function generateLesson(videoId: string, difficultyStr: string) {
  try {
    // Parse difficulty
    const difficultyResult = Difficulty.fromString(difficultyStr)
    if (difficultyResult.isFailure) {
      return Result.fail({ type: 'INVALID_DIFFICULTY', message: 'Invalid difficulty level' })
    }

    // Build dependencies
    const transcriptRepo = new PrismaTranscriptRepository(prisma)
    const transcriptFetcher = new YouTubeTranscriptService()
    const chunker = new ChunkTranscriptUseCase()

    const fetchTranscript = new FetchTranscriptUseCase(
      transcriptRepo,
      transcriptFetcher,
      chunker
    )

    const lessonRepo = new PrismaLessonRepository(prisma)
    const lessonGenerator = new OpenAILessonGenerator()

    const generateLessonUseCase = new GenerateLessonUseCase(
      lessonRepo,
      fetchTranscript,
      lessonGenerator
    )

    // Execute
    const videoUrl = `https://www.youtube.com/watch?v=${videoId}`
    const lessonResult = await generateLessonUseCase.execute({
      videoUrl,
      difficulty: difficultyResult.value
    })

    if (lessonResult.isFailure) {
      return Result.fail({
        type: 'GENERATION_FAILED',
        message: lessonResult.error.message
      })
    }

    // Also fetch transcript for chunks
    const transcriptResult = await fetchTranscript.execute(videoUrl)

    return Result.ok({
      lesson: lessonResult.value,
      transcript: transcriptResult.isSuccess ? transcriptResult.value : null
    })
  } catch (error) {
    return Result.fail({
      type: 'UNEXPECTED_ERROR',
      message: String(error)
    })
  }
}
```

### 6. Lesson Provider

```typescript
// src/app/lesson/[videoId]/lesson-provider.tsx
'use client'

import { useEffect } from 'react'
import { useLessonStore } from '@/features/lesson/presentation/stores/lesson-store'
import { usePlayerStore } from '@/features/player/presentation/stores/player-store'
import type { Lesson } from '@/features/lesson/domain/entities/lesson'
import type { Transcript } from '@/features/transcript/domain/entities/transcript'

interface LessonProviderProps {
  lesson: Lesson
  transcript: Transcript | null
  children: React.ReactNode
}

export function LessonProvider({ lesson, transcript, children }: LessonProviderProps) {
  const { setLesson } = useLessonStore()
  const { setChunks } = usePlayerStore()

  useEffect(() => {
    setLesson(lesson)
    if (transcript) {
      setChunks(transcript.chunks)
    }
  }, [lesson, transcript, setLesson, setChunks])

  return <>{children}</>
}
```

### 7. Testes E2E

```typescript
// tests/e2e/lesson-flow.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Full Lesson Flow', () => {
  test('should generate lesson from YouTube URL', async ({ page }) => {
    await page.goto('/')

    // Enter URL
    await page.fill('[data-testid="url-input"]', 'https://www.youtube.com/watch?v=dQw4w9WgXcQ')

    // Select difficulty
    await page.click('[data-testid="difficulty-select"]')
    await page.click('text=Medium')

    // Submit
    await page.click('[data-testid="submit-button"]')

    // Should navigate to lesson page
    await expect(page).toHaveURL(/\/lesson\/dQw4w9WgXcQ/)

    // Should show video player
    await expect(page.locator('#youtube-player-dQw4w9WgXcQ')).toBeVisible({ timeout: 30000 })

    // Should show exercises
    await expect(page.locator('[data-testid="question"]')).toBeVisible()

    // Should show vocabulary
    await expect(page.locator('[data-testid="vocab-0"]')).toBeVisible()
  })

  test('should complete lesson and show score', async ({ page }) => {
    await page.goto('/lesson/dQw4w9WgXcQ?difficulty=easy')

    // Wait for lesson to load
    await expect(page.locator('[data-testid="question"]')).toBeVisible({ timeout: 30000 })

    // Answer exercises (mocked data)
    for (let i = 0; i < 5; i++) {
      // Check if multiple choice or fill-blank
      const hasOptions = await page.locator('[data-testid="option-0"]').isVisible()

      if (hasOptions) {
        await page.click('[data-testid="option-0"]')
      } else {
        await page.fill('[data-testid="answer-input"]', 'test')
        await page.click('[data-testid="submit-button"]')
      }

      await page.click('[data-testid="next-button"]')
    }

    // Should show completion message
    await expect(page.locator('text=Lesson Complete')).toBeVisible()
    await expect(page.locator('text=Score')).toBeVisible()
  })

  test('should show error for invalid URL', async ({ page }) => {
    await page.goto('/')

    await page.fill('[data-testid="url-input"]', 'invalid-url')
    await page.click('[data-testid="submit-button"]')

    await expect(page.locator('[data-testid="error-message"]')).toBeVisible()
  })
})

// tests/e2e/home.spec.ts
test.describe('Home Page', () => {
  test('should render home page', async ({ page }) => {
    await page.goto('/')

    await expect(page.locator('h1')).toContainText('Learn English with YouTube')
    await expect(page.locator('[data-testid="url-input"]')).toBeVisible()
  })

  test('should have difficulty selector', async ({ page }) => {
    await page.goto('/')

    await page.click('[data-testid="difficulty-select"]')

    await expect(page.locator('text=Easy')).toBeVisible()
    await expect(page.locator('text=Medium')).toBeVisible()
    await expect(page.locator('text=Hard')).toBeVisible()
  })
})
```

## Criterios de Aceite

- [ ] Home page com input de URL e selector de dificuldade
- [ ] Validacao de URL YouTube no cliente
- [ ] Navegacao para /lesson/[videoId]
- [ ] Lesson page carrega video player
- [ ] Lesson page mostra exercicios interativos
- [ ] Lesson page mostra vocabulario
- [ ] ChunkNavigator integrado com player
- [ ] Server action gera lesson via use case
- [ ] Loading e error states implementados
- [ ] Layout responsivo (mobile + desktop)
- [ ] Testes E2E passam

## Validacao

```bash
pnpm build
pnpm test:e2e tests/e2e/
```

---

## Tags de Contexto

```
PRD: visao, features/player, features/lesson
ARQUITETURA: visao-geral, stack
```

---

## Notas

- Server Actions para geracao de lesson (RSC pattern)
- Suspense boundaries para loading states
- Zustand stores hydratados via provider
- Layout grid responsivo com Tailwind
- Esta e a tarefa final de integracao
