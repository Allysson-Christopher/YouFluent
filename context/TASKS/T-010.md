# T-010: Presentation - ChunkNavigator + Zustand Store

| Campo | Valor |
|-------|-------|
| **Tamanho** | M |
| **Prioridade** | Must Have |
| **Epic** | Player |
| **Depende de** | T-007, T-009 |
| **TDD** | Component (Vitest) + E2E (Playwright) |

---

## Contexto

Criar componente de navegacao por chunks com destaque do chunk atual e integracao com Zustand store para estado global do player.

## Objetivo

ChunkNavigator funcional com Zustand store para gerenciar estado do player e navegacao por chunks.

## Escopo

- Zustand store para player state
- Componente ChunkNavigator (lista de chunks)
- Destaque do chunk atual baseado no tempo
- Click em chunk = seek no video
- Testes de componente e E2E

## Arquivos a Criar

```
src/features/player/
└── presentation/
    ├── stores/
    │   └── player-store.ts
    └── components/
        ├── chunk-navigator.tsx
        └── chunk-navigator.test.tsx

tests/e2e/
└── player/
    └── chunk-navigator.spec.ts
```

## Implementacao

### 1. Zustand Player Store

```typescript
// src/features/player/presentation/stores/player-store.ts
import { create } from 'zustand'
import type { PlayerAdapter } from '../../domain/interfaces/player-adapter'
import type { Chunk } from '@/features/transcript/domain/entities/chunk'

interface PlayerState {
  // State
  adapter: PlayerAdapter | null
  isPlaying: boolean
  currentTime: number
  duration: number
  playbackRate: number
  chunks: Chunk[]
  activeChunkIndex: number

  // Actions
  setAdapter: (adapter: PlayerAdapter) => void
  setPlaying: (isPlaying: boolean) => void
  setCurrentTime: (time: number) => void
  setDuration: (duration: number) => void
  setPlaybackRate: (rate: number) => void
  setChunks: (chunks: Chunk[]) => void

  // Derived actions
  play: () => void
  pause: () => void
  seekToChunk: (index: number) => void
  togglePlayPause: () => void
}

export const usePlayerStore = create<PlayerState>((set, get) => ({
  // Initial state
  adapter: null,
  isPlaying: false,
  currentTime: 0,
  duration: 0,
  playbackRate: 1,
  chunks: [],
  activeChunkIndex: 0,

  // Setters
  setAdapter: (adapter) => set({ adapter }),
  setPlaying: (isPlaying) => set({ isPlaying }),
  setCurrentTime: (time) => {
    const { chunks } = get()
    const activeChunkIndex = chunks.findIndex(
      (chunk) => time >= chunk.startTime && time < chunk.endTime
    )
    set({ currentTime: time, activeChunkIndex: Math.max(0, activeChunkIndex) })
  },
  setDuration: (duration) => set({ duration }),
  setPlaybackRate: (rate) => {
    get().adapter?.setPlaybackRate(rate)
    set({ playbackRate: rate })
  },
  setChunks: (chunks) => set({ chunks }),

  // Actions
  play: () => {
    get().adapter?.play()
    set({ isPlaying: true })
  },
  pause: () => {
    get().adapter?.pause()
    set({ isPlaying: false })
  },
  seekToChunk: (index) => {
    const { chunks, adapter } = get()
    const chunk = chunks[index]
    if (chunk && adapter) {
      adapter.seekTo(chunk.startTime)
      set({ activeChunkIndex: index })
    }
  },
  togglePlayPause: () => {
    const { isPlaying, play, pause } = get()
    isPlaying ? pause() : play()
  },
}))
```

### 2. ChunkNavigator Component

```typescript
// src/features/player/presentation/components/chunk-navigator.tsx
'use client'

import { usePlayerStore } from '../stores/player-store'
import { cn } from '@/shared/lib/utils'

export function ChunkNavigator() {
  const { chunks, activeChunkIndex, seekToChunk, currentTime } = usePlayerStore()

  const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60)
    const secs = Math.floor(seconds % 60)
    return `${mins}:${secs.toString().padStart(2, '0')}`
  }

  if (chunks.length === 0) {
    return <div className="text-muted-foreground">Loading chunks...</div>
  }

  return (
    <div className="space-y-2">
      <h3 className="font-medium text-sm text-muted-foreground">
        Chunks ({chunks.length})
      </h3>
      <ul className="space-y-1 max-h-96 overflow-y-auto">
        {chunks.map((chunk, index) => (
          <li key={chunk.id ?? index}>
            <button
              data-testid={`chunk-${index}`}
              onClick={() => seekToChunk(index)}
              className={cn(
                'w-full text-left p-2 rounded-md text-sm transition-colors',
                'hover:bg-accent hover:text-accent-foreground',
                index === activeChunkIndex && 'bg-primary text-primary-foreground'
              )}
            >
              <div className="flex justify-between items-center">
                <span className="font-mono text-xs">
                  {formatTime(chunk.startTime)} - {formatTime(chunk.endTime)}
                </span>
                <span className="text-xs opacity-70">
                  {index + 1}/{chunks.length}
                </span>
              </div>
              <p className="mt-1 line-clamp-2">{chunk.text}</p>
            </button>
          </li>
        ))}
      </ul>
    </div>
  )
}
```

### 3. Testes de Componente

```typescript
// src/features/player/presentation/components/chunk-navigator.test.tsx
import { render, screen, fireEvent } from '@testing-library/react'
import { ChunkNavigator } from './chunk-navigator'
import { usePlayerStore } from '../stores/player-store'

// Mock do store
vi.mock('../stores/player-store')

describe('ChunkNavigator', () => {
  const mockChunks = [
    { id: '1', index: 0, startTime: 0, endTime: 30, text: 'First chunk' },
    { id: '2', index: 1, startTime: 30, endTime: 60, text: 'Second chunk' },
    { id: '3', index: 2, startTime: 60, endTime: 90, text: 'Third chunk' },
  ]

  beforeEach(() => {
    vi.mocked(usePlayerStore).mockReturnValue({
      chunks: mockChunks,
      activeChunkIndex: 0,
      seekToChunk: vi.fn(),
      currentTime: 0,
    })
  })

  it('should render all chunks', () => {
    render(<ChunkNavigator />)

    expect(screen.getByText('First chunk')).toBeInTheDocument()
    expect(screen.getByText('Second chunk')).toBeInTheDocument()
    expect(screen.getByText('Third chunk')).toBeInTheDocument()
  })

  it('should highlight active chunk', () => {
    vi.mocked(usePlayerStore).mockReturnValue({
      chunks: mockChunks,
      activeChunkIndex: 1,
      seekToChunk: vi.fn(),
      currentTime: 35,
    })

    render(<ChunkNavigator />)

    const secondChunk = screen.getByTestId('chunk-1')
    expect(secondChunk).toHaveClass('bg-primary')
  })

  it('should seek to chunk on click', () => {
    const seekToChunk = vi.fn()
    vi.mocked(usePlayerStore).mockReturnValue({
      chunks: mockChunks,
      activeChunkIndex: 0,
      seekToChunk,
      currentTime: 0,
    })

    render(<ChunkNavigator />)

    fireEvent.click(screen.getByTestId('chunk-2'))
    expect(seekToChunk).toHaveBeenCalledWith(2)
  })
})
```

### 4. Teste E2E

```typescript
// tests/e2e/player/chunk-navigator.spec.ts
import { test, expect } from '@playwright/test'

test.describe('ChunkNavigator', () => {
  test('should navigate between chunks', async ({ page }) => {
    await page.goto('/lesson/dQw4w9WgXcQ')

    // Wait for chunks to load
    await expect(page.locator('[data-testid="chunk-0"]')).toBeVisible()

    // Click on third chunk
    await page.click('[data-testid="chunk-2"]')

    // Should highlight the clicked chunk
    await expect(page.locator('[data-testid="chunk-2"]')).toHaveClass(/bg-primary/)

    // Video time should update
    await expect(page.locator('[data-testid="current-time"]')).toContainText('1:00')
  })

  test('should auto-highlight chunk as video plays', async ({ page }) => {
    await page.goto('/lesson/dQw4w9WgXcQ')

    // Start playing
    await page.click('[data-testid="play-button"]')

    // Wait for video to reach second chunk (30s)
    await page.waitForTimeout(32000) // Wait 32s

    // Second chunk should be highlighted
    await expect(page.locator('[data-testid="chunk-1"]')).toHaveClass(/bg-primary/)
  })
})
```

## Criterios de Aceite

- [ ] Zustand store gerencia estado do player
- [ ] ChunkNavigator exibe todos os chunks
- [ ] Chunk ativo e destacado visualmente
- [ ] Click em chunk executa seek no video
- [ ] Chunk ativo atualiza automaticamente durante playback
- [ ] Store e reativo (updates automaticos)
- [ ] Testes de componente passam
- [ ] Testes E2E passam

## Validacao

```bash
pnpm test src/features/player/presentation/
pnpm test:e2e tests/e2e/player/chunk-navigator.spec.ts
```

---

## Tags de Contexto

```
PRD: features/player
ARQUITETURA: dominios/player, stack, decisoes/adr-003-zustand
```

---

## Notas

- Zustand 5.x e minimalista e performatico
- Store usa selectors para evitar re-renders
- activeChunkIndex calculado automaticamente no setCurrentTime
- cn() helper para classes condicionais (shadcn pattern)
