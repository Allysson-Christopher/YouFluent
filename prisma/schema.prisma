// YouFluent Database Schema
// Prisma 7.x with PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ====================
// TRANSCRIPT DOMAIN (T-006)
// ====================

model Transcript {
  id        String   @id @default(cuid())
  videoId   String   @unique
  title     String
  language  String   @default("en")
  fullText  String   @db.Text
  createdAt DateTime @default(now())
  chunks    Chunk[]
  chunkLessons ChunkLesson[]

  @@index([videoId])
}

model Chunk {
  id           String     @id @default(cuid())
  index        Int
  startTime    Float
  endTime      Float
  text         String     @db.Text
  transcriptId String
  transcript   Transcript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)

  @@index([transcriptId])
}

// ====================
// LESSON DOMAIN (Refactored to match original Python version)
// ====================

// ChunkLesson: Generated content for a single chunk
// Matches original: translation, explanation, vocabulary (2-4), exercise (1)
model ChunkLesson {
  id           String   @id @default(cuid())
  chunkIndex   Int
  translation  String   @db.Text  // Portuguese translation
  explanation  String   @db.Text  // Grammar/expression explanation
  createdAt    DateTime @default(now())

  transcriptId String
  transcript   Transcript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)

  vocabulary ChunkVocabulary[]
  exercise   ChunkExercise?

  @@unique([transcriptId, chunkIndex])
  @@index([transcriptId])
}

model ChunkVocabulary {
  id            String @id @default(cuid())
  word          String
  meaning       String @db.Text  // Portuguese meaning (simpler than "definition")

  chunkLessonId String
  chunkLesson   ChunkLesson @relation(fields: [chunkLessonId], references: [id], onDelete: Cascade)

  @@index([chunkLessonId])
}

model ChunkExercise {
  id            String   @id @default(cuid())
  question      String   @db.Text  // Question in Portuguese
  options       String[]            // 4 options
  correctIndex  Int                 // Index 0-3 of correct answer

  chunkLessonId String   @unique
  chunkLesson   ChunkLesson @relation(fields: [chunkLessonId], references: [id], onDelete: Cascade)
}

// Legacy models kept for backwards compatibility (can be removed later)
model Lesson {
  id         String   @id @default(cuid())
  videoId    String   @unique
  title      String
  difficulty String   @default("medium")
  createdAt  DateTime @default(now())

  exercises  Exercise[]
  vocabulary VocabularyItem[]

  @@index([videoId])
}

model Exercise {
  id          String   @id @default(cuid())
  type        String   // fill-blank, multiple-choice, translation, listening
  question    String   @db.Text
  answer      String
  options     String[] // Array vazio para tipos sem opcoes
  explanation String   @db.Text
  chunkIndex  Int

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

model VocabularyItem {
  id           String @id @default(cuid())
  word         String
  definition   String @db.Text
  example      String @db.Text
  partOfSpeech String // noun, verb, adjective, adverb, phrase
  chunkIndex   Int

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}
